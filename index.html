<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台語語詞克漏字測驗</title>
    <style>
        /* 1. 從 Google Fonts 匯入 Charis SIL 與 思源黑體 (Noto Sans TC) */
        @import url('https://fonts.googleapis.com/css2?family=Charis+SIL:ital,wght@0,400;0,700;1,400;1,700&family=Noto+Sans+TC:wght@400;700&display=swap');

        /* 2. 全域設定：套用粉色背景與字體順序 */
        body { 
            font-family: 'Charis SIL', 'Noto Sans TC', sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            background: #fdf2f8; /* 淺粉紅背景 */
            margin: 0; 
            padding: 20px; 
        }
        #quiz-container { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(219, 39, 119, 0.1); /* 帶有粉色調的陰影 */
            width: 100%; 
            max-width: 500px; 
            text-align: center; 
        }
        .question-box { 
            background: #fce7f3; /* 題目框的粉紅背景 */
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
        }
        
        /* 3. 字體大小與顏色調整 */
        .question-text { 
            font-size: 40px; /* 原 32px -> 放大為 40px */
            font-weight: bold; 
            color: #9d174d; /* 深粉紅色 */
            letter-spacing: 2px; 
        }
        .hint-text { 
            font-size: 24px; /* 原 18px -> 放大為 24px */
            color: #831843; 
            margin-top: 15px; 
            line-height: 1.5; 
            min-height: 3em; 
        }
        .options { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
        }
        button { 
            padding: 15px; 
            font-size: 26px; /* 原 20px -> 放大為 26px */
            font-family: 'Charis SIL', 'Noto Sans TC', sans-serif; /* 確保按鈕也套用字體 */
            cursor: pointer; 
            border: 2px solid #fbcfe8; /* 淺粉色邊框 */
            border-radius: 8px; 
            background: white; 
            transition: all 0.2s; 
        }
        button:hover:not(:disabled) { 
            background: #fdf2f8; 
            border-color: #db2777; /* 滑鼠移過去變成桃粉色 */
            color: #db2777; 
        }
        button:disabled { cursor: default; }
        
        #score-board { margin-top: 20px; font-size: 22px; font-weight: bold; color: #9d174d; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="quiz-container">
    <div id="setup"><h2>載入中...</h2></div>
    <div id="quiz-box" class="hidden">
        <div id="progress" style="margin-bottom: 10px; color: #db2777; font-size: 18px;">第 1 / 100 題</div>
        <div class="question-box">
            <div class="question-text" id="question-display"></div>
            <div class="hint-text" id="hint-display">載入中...</div>
        </div>
        <div class="options" id="options-container"></div>
        <div id="score-board">目前分數: 0</div>
    </div>
    <div id="result" class="hidden">
        <h2 style="color: #9d174d; font-size: 32px;">測驗完成！</h2>
        <p id="final-score" style="font-size: 24px;"></p>
        <button onclick="location.reload()" style="width: 100%; background: #db2777; color: white; border: none;">重新挑戰</button>
    </div>
</div>

<div style="margin-top: 20px; color: #db2777; font-size: 16px; text-align: center;">
    本站總瀏覽人次：<span id="busuanzi_value_site_pv">載入中</span> 次
</div>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script>
// --- ⚠️ 請記得在這裡貼上你的 Google Sheets CSV 連結 ---
const CSV_URL = '你的_GOOGLE_SHEET_CSV_連結';

let allData = [];
let quizList = [];
let currentIndex = 0;
let score = 0;

async function init() {
    try {
        const response = await fetch(CSV_URL);
        const data = await response.text();
        const rows = data.split('\n').slice(1).filter(r => r.trim() !== '');
        
        allData = rows.map(row => {
            const cols = row.split(',');
            return { hanji: cols[0].trim(), phingim: cols[1].trim() };
        });

        let history = JSON.parse(localStorage.getItem('taigi_quiz_history') || "[]");
        let availablePool = allData.filter(q => !history.includes(q.hanji + q.phingim));

        if (availablePool.length < 100) {
            availablePool = allData;
            history = [];
        }

        const shuffled = availablePool.sort(() => 0.5 - Math.random());
        const selected = shuffled.slice(0, 100);

        const newHistory = [...history, ...selected.map(q => q.hanji + q.phingim)];
        if (newHistory.length > 500) {
            newHistory.splice(0, newHistory.length - 500);
        }
        localStorage.setItem('taigi_quiz_history', JSON.stringify(newHistory));

        const part1 = selected.slice(0, 50).map(q => ({...q, type: 'H'}));
        const part2 = selected.slice(50, 100).map(q => ({...q, type: 'P'}));
        
        quizList = [...part1, ...part2].sort(() => 0.5 - Math.random());
        
        document.getElementById('setup').classList.add('hidden');
        document.getElementById('quiz-box').classList.remove('hidden');
        renderQuestion();
    } catch (e) { document.getElementById('setup').innerText = "載入失敗"; console.error(e); }
}

function renderQuestion() {
    if (currentIndex >= quizList.length) { showResult(); return; }
    const current = quizList[currentIndex];
    const isHanji = current.type === 'H';
    let parts = isHanji ? current.hanji.split('') : current.phingim.split('-');
    const blankIndex = Math.floor(Math.random() * parts.length);
    const correctAnswer = parts[blankIndex];
    let displayParts = [...parts];
    displayParts[blankIndex] = "（　）";
    
    document.getElementById('progress').innerText = `第 ${currentIndex + 1} / ${quizList.length} 題`;
    document.getElementById('question-display').innerText = isHanji ? displayParts.join('') : displayParts.join('-');
    document.getElementById('hint-display').innerHTML = isHanji ? `提示：${current.phingim}` : `提示：${current.hanji}`;

    let distractors = allData.flatMap(d => isHanji ? d.hanji.split('') : d.phingim.split('-')).filter(i => i !== correctAnswer && i.length > 0);
    let options = [correctAnswer, ...[...new Set(distractors)].sort(() => 0.5 - Math.random()).slice(0, 3)];
    options.sort(() => 0.5 - Math.random());

    const container = document.getElementById('options-container');
    container.innerHTML = '';
    options.forEach(opt => {
        const btn = document.createElement('button');
        btn.innerText = opt;
        btn.onclick = () => checkAnswer(opt, correctAnswer);
        container.appendChild(btn);
    });
}

function checkAnswer(selected, correct) {
    const current = quizList[currentIndex];
    const buttons = document.getElementById('options-container').getElementsByTagName('button');
    for (let btn of buttons) {
        btn.disabled = true;
        /* 答對維持柔和綠色，答錯維持柔和紅色，這在 UI 體驗上最直覺 */
        if (btn.innerText === correct) { btn.style.background = "#dcfce7"; btn.style.borderColor = "#22c55e"; }
        if (btn.innerText === selected && selected !== correct) { btn.style.background = "#fee2e2"; btn.style.borderColor = "#ef4444"; }
    }
    const hintBox = document.getElementById('hint-display');
    if (selected === correct) {
        score++;
        hintBox.innerHTML = `<b style="color: #22c55e;">正確！</b><br>完整語詞：${current.hanji} (${current.phingim})`;
    } else {
        hintBox.innerHTML = `<b style="color: #ef4444;">答錯了...</b><br>正確答案是「${correct}」<br>完整語詞：${current.hanji} (${current.phingim})`;
    }
    document.getElementById('score-board').innerText = `目前分數: ${score}`;
    setTimeout(() => { currentIndex++; renderQuestion(); }, 2000);
}

function showResult() {
    document.getElementById('quiz-box').classList.add('hidden');
    document.getElementById('result').classList.remove('hidden');
    document.getElementById('final-score').innerText = `你的得分：${score} / ${quizList.length}`;
}
init();
</script>
</body>
</html>
