<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台語語詞克漏字測驗</title>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; display: flex; flex-direction: column; align-items: center; background: #f0f2f5; margin: 0; padding: 20px; }
        #quiz-container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 100%; max-width: 500px; text-align: center; }
        .question-box { background: #eef2ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .question-text { font-size: 32px; font-weight: bold; color: #1e3a8a; letter-spacing: 2px; }
        .hint-text { font-size: 18px; color: #475569; margin-top: 15px; line-height: 1.5; min-height: 3em; }
        .options { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        button { padding: 15px; font-size: 20px; cursor: pointer; border: 2px solid #e2e8f0; border-radius: 8px; background: white; transition: all 0.2s; }
        button:hover:not(:disabled) { background: #f8fafc; border-color: #3b82f6; color: #3b82f6; }
        button:disabled { cursor: default; }
        #score-board { margin-top: 20px; font-weight: bold; color: #334155; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="quiz-container">
    <div id="setup"><h2>載入中...</h2></div>
    <div id="quiz-box" class="hidden">
        <div id="progress" style="margin-bottom: 10px; color: #64748b;">第 1 / 100 題</div>
        <div class="question-box">
            <div class="question-text" id="question-display"></div>
            <div class="hint-text" id="hint-display">載入中...</div>
        </div>
        <div class="options" id="options-container"></div>
        <div id="score-board">目前分數: 0</div>
    </div>
    <div id="result" class="hidden">
        <h2>測驗完成！</h2>
        <p id="final-score"></p>
        <button onclick="location.reload()" style="width: 100%; background: #3b82f6; color: white;">重新挑戰</button>
    </div>
</div>

<script>
// --- 請記得替換你的 CSV 連結 ---
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQL_qfHDa8zQs3krnY7DFt-PZSKy2rEsu22Vt1iEe41NfaL6h6ix24IDNG33Pefy_cK7eN6aeOFYhTN/pub?output=csv';

let allData = [];
let quizList = [];
let currentIndex = 0;
let score = 0;

async function init() {
    try {
        const response = await fetch(CSV_URL);
        const data = await response.text();
        const rows = data.split('\n').slice(1).filter(r => r.trim() !== '');
        
        allData = rows.map(row => {
            const cols = row.split(',');
            return { hanji: cols[0].trim(), phingim: cols[1].trim() };
        });

        // --- 新增：排除重複機制 ---
        // 從瀏覽器記憶體取得「已考過的題目 ID」清單
        let history = JSON.parse(localStorage.getItem('taigi_quiz_history') || "[]");
        
        // 過濾掉最近出現過的題目（若題庫夠大，則排除歷史紀錄中的題目）
        // 假設每次 100 題，存 5 次即排除 500 題
        let availablePool = allData.filter(q => !history.includes(q.hanji + q.phingim));

        // 如果剩餘題目不足 100 題，清空歷史紀錄重新開始（保險機制）
        if (availablePool.length < 100) {
            availablePool = allData;
            history = [];
        }

        const shuffled = availablePool.sort(() => 0.5 - Math.random());
        const selected = shuffled.slice(0, 100);

        // 將這 100 題加入歷史紀錄
        const newHistory = [...history, ...selected.map(q => q.hanji + q.phingim)];
        // 只保留最近 500 題的紀錄 (5次測驗)
        if (newHistory.length > 500) {
            newHistory.splice(0, newHistory.length - 500);
        }
        localStorage.setItem('taigi_quiz_history', JSON.stringify(newHistory));
        // --- 結束排除機制 ---

        const part1 = selected.slice(0, 50).map(q => ({...q, type: 'H'}));
        const part2 = selected.slice(50, 100).map(q => ({...q, type: 'P'}));
        
        quizList = [...part1, ...part2].sort(() => 0.5 - Math.random());
        
        document.getElementById('setup').classList.add('hidden');
        document.getElementById('quiz-box').classList.remove('hidden');
        renderQuestion();
    } catch (e) { 
        document.getElementById('setup').innerText = "載入失敗"; 
        console.error(e);
    }
}
function renderQuestion() {
    if (currentIndex >= quizList.length) { showResult(); return; }
    const current = quizList[currentIndex];
    const isHanji = current.type === 'H';
    let parts = isHanji ? current.hanji.split('') : current.phingim.split('-');
    const blankIndex = Math.floor(Math.random() * parts.length);
    const correctAnswer = parts[blankIndex];
    let displayParts = [...parts];
    displayParts[blankIndex] = "（　）";
    
    document.getElementById('progress').innerText = `第 ${currentIndex + 1} / ${quizList.length} 題`;
    document.getElementById('question-display').innerText = isHanji ? displayParts.join('') : displayParts.join('-');
    document.getElementById('hint-display').innerHTML = isHanji ? `提示：${current.phingim}` : `提示：${current.hanji}`;

    let distractors = allData.flatMap(d => isHanji ? d.hanji.split('') : d.phingim.split('-')).filter(i => i !== correctAnswer && i.length > 0);
    let options = [correctAnswer, ...[...new Set(distractors)].sort(() => 0.5 - Math.random()).slice(0, 3)];
    options.sort(() => 0.5 - Math.random());

    const container = document.getElementById('options-container');
    container.innerHTML = '';
    options.forEach(opt => {
        const btn = document.createElement('button');
        btn.innerText = opt;
        btn.onclick = () => checkAnswer(opt, correctAnswer);
        container.appendChild(btn);
    });
}

function checkAnswer(selected, correct) {
    const current = quizList[currentIndex];
    const buttons = document.getElementById('options-container').getElementsByTagName('button');
    for (let btn of buttons) {
        btn.disabled = true;
        if (btn.innerText === correct) { btn.style.background = "#dcfce7"; btn.style.borderColor = "#22c55e"; }
        if (btn.innerText === selected && selected !== correct) { btn.style.background = "#fee2e2"; btn.style.borderColor = "#ef4444"; }
    }
    const hintBox = document.getElementById('hint-display');
    if (selected === correct) {
        score++;
        hintBox.innerHTML = `<b style="color: #22c55e;">正確！</b><br>完整語詞：${current.hanji} (${current.phingim})`;
    } else {
        hintBox.innerHTML = `<b style="color: #ef4444;">答錯了...</b><br>正確答案是「${correct}」<br>完整語詞：${current.hanji} (${current.phingim})`;
    }
    document.getElementById('score-board').innerText = `目前分數: ${score}`;
    setTimeout(() => { currentIndex++; renderQuestion(); }, 2000);
}

function showResult() {
    document.getElementById('quiz-box').classList.add('hidden');
    document.getElementById('result').classList.remove('hidden');
    document.getElementById('final-score').innerText = `你的得分：${score} / ${quizList.length}`;
}
init();
</script>
</body>
</html>

